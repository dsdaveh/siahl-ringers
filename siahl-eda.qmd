---
title: "SIAHL Stats EDA"
format: html
editor: visual
---

```{r}
#| message: false
#| warning: false
library(tidyverse)
players <- readRDS(file = "player_stats-2023-05-31 19:08:26.236042.RDS") %>% 
    mutate(across(where(~ all(!is.na(as.numeric(.)))), as.numeric, .names = "{.col}"))
```

```{r}

# add Division Rank, but this should get moved the ETL portion
# for now we rely on the knowledge that the data was collected in ranked order

# team_ranks <- team_ranks <- readRDS(file = '~/Downloads/teams.RDS') %>% 
#     select(Team = team, Division = division , Rank = division_rank) 
# 
# players <- left_join(players, team_ranks, by = c("Team", "Division"))


```

Players in more than one division

```{r}
multi_div <- players %>% 
    count(Name) %>% 
    filter(n > 1)

players_multi <- multi_div %>% 
    left_join(players, by = "Name") 
```

```{r}
xleague_stats <- players_multi %>% 
    mutate(PpG = Pts / GP,
           GpG = Goals / GP,
           DivLevel = str_extract(Division, '\\d+') %>% as.numeric()) %>% 
    group_by(Name) %>% 
    arrange(Division) %>% 
    summarise(n_leagues = n(),
              best_level = min(DivLevel),
              gp_as_ringer = sum(ifelse(DivLevel > (best_level + 2), GP, 0)),
              # min_Goals = min(Goals),
              # max_Goals = max(Goals),
              # min_Pts = min(Pts),
              # max_Pts = max(Pts),
              min_PpG = min(PpG),
              max_PpG = max(PpG),
              PpG_spread = last(PpG) - first(PpG),
              GpG_spread = last(GpG) - first(GpG),
              Div_spread = last(DivLevel) - first(DivLevel),
              `L/H Divs` = sprintf("%s-%s", first(Division), last(Division)) )
```

```{r}
ringers <- xleague_stats %>% filter(Div_spread > 2)
```

Which teams have the most ringers

```{r}
teams <- players %>% 
    mutate(DivLevel = str_extract(Division, '\\d+') %>% as.numeric()) %>% 
    left_join(ringers %>% select(Name, ringer_level = best_level) , by = 'Name') %>% 
    mutate(ringer_count = ifelse((DivLevel - ringer_level) > 2, 1, 0))

team_stats <- teams %>% 
    group_by(Team, Division, Rank) %>% 
    summarise(ringer_count = sum(ringer_count, na.rm = TRUE),
              ringer_games_count = sum(ringer_count * GP, na.rm = TRUE),
              .groups = 'drop')
```
