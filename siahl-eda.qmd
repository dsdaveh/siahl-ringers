---
title: "SIAHL Stats EDA"
format: html
editor: visual
---

```{r}
#| message: false
#| warning: false
library(tidyverse)
library(rvest)
library(xml2)
```

```{r}
base_url <- "https://stats.sharksice.timetoscore.com/"

# Define the URL
url <- paste0(base_url, "display-stats.php?league=1&season=56")

# Read the webpage
webpage <- read_html(url)

# Scrape the Adult Division names
divisions <- webpage %>%
  html_elements("tr") %>%
  html_text(trim = TRUE) %>%
  .[str_detect(., "Adult Division")] 

team_divisions <- webpage %>%
  html_elements("tr") %>%
  html_text(trim = TRUE) 

division_assignments <- ""
for (i in 2:length(team_divisions)) {
    division_assignments <- c(division_assignments,
                              ifelse(str_detect(team_divisions[i], 'Adult Division'),
                                     team_divisions, division_assignments[i-1]))
}
    
    
team_names  <- webpage %>%
  html_elements("td a") %>%
  html_text(trim = TRUE) 

# Find URLs of each team page
team_urls <- webpage %>%
    html_elements("td a") %>%
    html_attr("href") %>%
    paste0("https://stats.sharksice.timetoscore.com/", .)

# Initialize an empty tibble for storing results
final_data <- tibble()

# Loop over each team URL
for (url in team_urls) {
  team_webpage <- read_html(url)
  
  # Get the team name
  team_name <- team_webpage %>%
    html_nodes("title") %>%
    html_text(trim = TRUE) %>%
    str_replace_all("San Jose Sharks Ice Team Statistics - ", "")
  
  # Get the Adult Division name
  adult_division <- divisions[which.max(str_detect(team_urls, url))]
  
  # Get the player stats table
  player_stats <- team_webpage %>%
    html_nodes("table") %>%
    .[2] %>%
    html_table(header = TRUE) %>%
    .[[1]] %>%
    mutate(Team = team_name, Adult_Division = adult_division)
  
  # Append the table to final_data
  final_data <- bind_rows(final_data, player_stats)
}
```

Get the team division information

```{r}
# Define the URL
url <- "https://stats.sharksice.timetoscore.com/display-stats.php?league=1&season=56"

# Read the webpage
webpage <- read_html(url)

# Scrape the Adult Division names and team rows
table_rows <- webpage %>%
  html_elements("tr") 

# Initialize an empty tibble for storing results
teams <- tibble()

# Initialize a variable to store the current division
current_division <- ""

# Loop over each table row
for (i in 1:length(table_rows)) {
  # Get the row
  row <- table_rows[[i]]
  team_extract <- row %>% html_elements("td a") %>%  html_text(trim = TRUE)

  # Check if it's a division row
  if (row %>% html_text() %>% str_detect("Adult Division")) {
    current_division <- row %>% html_text()
  # Check if it's a team row
  } else if (length(team_extract) > 0) {
    team_name <- row %>% html_elements("td a") %>%  html_text(trim = TRUE)
    team_stats <- paste0(base_url, row %>% html_elements("td a") %>%  html_attr("href"))

    team_data <- tibble(
      team = team_name,
      team_id = team_stats %>%  str_extract('\\?team=\\d+') %>% str_extract('\\d+'),
      team_stats = team_stats,
      division = current_division %>% str_replace('Adult Division ', '')
    )

    # Append the team data to final_data
    teams <- bind_rows(teams, team_data)
  }
  i = i+1
}
```
